<template>
	<view class="login">
		<view class="top_box">
			<image src="/static/bg/login_bg.png" class="bg"></image>
			<image src="/static/login_text.png" class="login_text" mode="widthFix"></image>
		</view>
		<view class="u-demo-area">
			<view class="container">
				<uv-form :model="loginForm" :rules="loginRules" ref="uForm" errorType="toast">
					<uv-form-item prop="userAccount" label-width="0" :borderBottom="false"
						:customStyle="{borderRadius:'16rpx',background:'#eee',padding:'20rpx'}">
						<uv-input border="none" class="u-input" :placeholderStyle="'fontSize:30rpx'"
							placeholder="请输入工号" v-model="loginForm.userAccount" type="text" prefixIcon="account"
							prefixIconStyle="font-size: 34rpx;color: rgba(0,0,0,0.85)" @confirm="formSubmit">
						</uv-input>
					</uv-form-item>
					<uv-form-item prop="password" label-width="0" :borderBottom="false"
						:customStyle="{borderRadius:'16rpx',background:'#eee',padding:'20rpx',marginTop:'30rpx'}">
						<uv-input :password-icon="true" :placeholderStyle="'fontSize:30rpx'" border="none"
							type="password" v-model="loginForm.password" placeholder="请输入密码" prefixIcon="lock"
							prefixIconStyle="font-size: 34rpx;color: rgba(0,0,0,0.85)" @confirm="formSubmit"></uv-input>
					</uv-form-item>
					<uv-form-item prop="department" label-width="0" :borderBottom="false" class="uv-flex"
						:customStyle="{borderRadius:'16rpx',background:'#eee',padding:'24rpx 20rpx',marginTop:'30rpx'}">
						<uv-icon name="order" :size="34" color="rgba(0,0,0,0.85)" style="margin-right:10rpx"></uv-icon>
						<picker class="uv-flex-1" :range="deptList" range-key="dictLabel" @change="setDept">
							<view class="uv-flex w-100">
								<text class="uv-flex-1" :class="{defaultColor:!loginForm.department}">{{loginForm.department||'请选择科室'}}</text>
								<uv-icon name="arrow-down" :size="34" color="rgba(0,0,0,0.85)"></uv-icon>
							</view>
						</picker>
					</uv-form-item>
				</uv-form>
				<uv-button @click="formSubmit" data-name="reg" type="primary" class="login-b" :shape="'circle'">登录</uv-button>
			</view>
		</view>
	</view>
</template>
<script>
	export default {
		data() {
			return {
				loginForm: {
					userAccount: "wangya",
					password: "Znzy123$",
					platform:'app',
					department:'血液内科',
				},
				loginRules: {
					userAccount: [{
						required: true,
						trigger: "blur",
						message: "请输入工号"
					}],
					password: [{
						required: true,
						trigger: "blur",
						message: "请输入密码"
					}],
					department:[{
						required: true,
						trigger: "change",
						message: "请选择科室"
					}]
				},
				isLoading:false,
				deptName:'',
				deptList:[],
			};
		},
		computed:{
			token(){
				return this.$store.state.token;
			}
		},
		onLoad() {
			if(this.token){
				this.$api.getInfo().then(res=>{
					this.$store.commit('SET_USERINFO',res.user);
					uni.redirectTo({
						url:'/pages/workPages/index'
					})
				})
			}else{
				this.$api.getDict('user_dept').then(res=>{
					this.deptList = res;
				})
				this.$api.getVersion()
			}
		},
		methods: {
			setDept(e){
				const index = e.detail.value;
				this.loginForm.department = this.deptList[index].dictLabel;
			},
			formSubmit() {
				this.$refs.uForm.validate().then(() => {
					if(this.isLoading) return;
					this.isLoading = true;
					this.$api.login(this.loginForm).then(res=>{
						this.$store.commit('SET_TOKEN',res.token);
						this.$api.getInfo().then(res=>{
							this.$store.commit('SET_USERINFO',res.user);
							uni.redirectTo({
								url:'/pages/workPages/index'
							})
						})
						uni.setStorageSync('token',res.token);
					}).finally(()=>{
						this.isLoading = false;
					})
				});
			},
		}
	};
</script>

<style lang="scss" scoped>
	.login {
		width: 100vw;
		height: 100vh;
		background: #fff;
		overflow: hidden;

		.top_box {
			width: 100%;
			height: 462rpx;
			position: relative;
			z-index: 2;
			display: flex;
			align-items: center;
			justify-content: center;

			.bg {
				width: 100%;
				height: 100%;
				position: absolute;
				top: 0;
				left: 0;
				z-index: -1;
			}

			.login_text {
				width: 480rpx;
				height: auto;
			}
		}
	}

	.u-demo-area {
		margin-top: 66rpx;
		padding: 0 16rpx;
	}

	.container {
		text-align: left;
		font-size: 32rpx;
		color: #fff;
		.defaultColor{
			font-size: 30rpx;
			color: #808080;
		}
	}

	.login-b {
		margin-top: 100upx;
		height: 100upx;
		width: 100%;
	}


</style>